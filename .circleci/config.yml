---
# https://rtfm.co.ua/circleci-obzor-continuous-integration-servisa/
# https://circleci.com/orbs/registry/orb/orbss/ansible-ssh#commands-ansible-playbook
# https://circleci.com/docs/2.0/docker-image-tags.json
# https://circleci.com/docs/2.0/sample-config/
# https://circleci.com/docs/2.0/reusing-config/#executor

# TODO. Сделать как-то более компактно, но я пока не знаю как.
# TODO. Test https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh
version: 2.1

# https://circleci.com/docs/2.0/reusing-config/#using-the-parameters-declaration
commands:

  command-run-ansible-test:
    description: "Run Ansible test"
    parameters:
      where:
        type: string
        default: '"localhost," -c local'
      path-to-test-yaml-file:
        type: string
        default: "tests/test.yml"
      verbose_level:
        type: string
        default: vvv
    steps:
      - run:
          name:
          # command: ansible-playbook -i "localhost," -c local tests/test.yml -vvv
          command: ansible-playbook -i << parameters.where >> << parameters.path-to-test-yaml-file >> -<< parameters.verbose_level >>

# https://circleci.com/docs/2.0/pipeline-variables/#pipeline-parameters-in-configuration
parameters:

  parameter-working-directory:
    type: string
    default: "~/.ansible/roles/ansible-role-install-snap"

  parameter-resource-class:
    type: string
    default: "small"

executors:

  executor-debian-oldstable:
    resource_class: << pipeline.parameters.parameter-resource-class >>
    docker:
      - image: geerlingguy/docker-debian9-ansible

  executor-debian-stable:
    resource_class: << pipeline.parameters.parameter-resource-class >>
    docker:
      - image: geerlingguy/docker-debian10-ansible

  # executor-debian-testing:
  #   resource_class: << pipeline.parameters.parameter-resource-class >>
  #   docker:
  #     - image: circleci/buildpack-deps:testing

  executor-ubuntu-16-04:
    resource_class: << pipeline.parameters.parameter-resource-class >>
    docker:
      - image: geerlingguy/docker-ubuntu1604-ansible

  executor-ubuntu-18-04:
    resource_class: << pipeline.parameters.parameter-resource-class >>
    docker:
      - image: geerlingguy/docker-ubuntu1804-ansible

  executor-ubuntu-20-04:
    resource_class: << pipeline.parameters.parameter-resource-class >>
    docker:
      - image: geerlingguy/docker-ubuntu2004-ansible

  executor-centos-7:
    resource_class: << pipeline.parameters.parameter-resource-class >>
    docker:
      - image: geerlingguy/docker-centos7-ansible

  executor-centos-8:
    resource_class: << pipeline.parameters.parameter-resource-class >>
    docker:
      - image: geerlingguy/docker-centos8-ansible

  executor-fedora-31:
    resource_class: << pipeline.parameters.parameter-resource-class >>
    docker:
      - image: geerlingguy/docker-fedora-31-ansible

  executor-fedora-32:
    resource_class: << pipeline.parameters.parameter-resource-class >>
    docker:
      - image: geerlingguy/docker-fedora-32-ansible

  # test-bridge:
  #   resource_class: << pipeline.parameters.parameter-resource-class >>
  #   docker:
  #     - image: rastasheep/ubuntu-sshd:16.04
  #     - image: geerlingguy/docker-centos8-ansible

jobs:

  # run-ansible-playbook-test-on-circlci-debian-oldstable:
  #   executor: executor-debian-oldstable
  #   working_directory: ~/.ansible/roles/ansible-role-install-snap
  #   steps:
  #     - checkout
  #     - run:
  #         name: Run Ansible test on "circleci/buildpack-deps:oldstable".
  #         command: |
  #           wget -O - https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh | sudo bash
  #           ansible-playbook -i "localhost," -c local tests/test.yml -vvv

  # run-ansible-playbook-test-on-circlci-debian-stable:
  #   executor: executor-debian-stable
  #   working_directory: ~/.ansible/roles/ansible-role-install-snap
  #   steps:
  #     - checkout
  #     - run:
  #         name: Run Ansible test on "circleci/buildpack-deps:stable".
  #         command: |
  #           wget -O - https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh | sudo bash
  #           ansible-playbook -i "localhost," -c local tests/test.yml -vvv

  # run-ansible-playbook-test-on-circlci-debian-testing:
  #   executor: executor-debian-testing
  #   working_directory: ~/.ansible/roles/ansible-role-install-snap
  #   steps:
  #     - checkout
  #     - run:
  #         name: Run Ansible test on "circleci/buildpack-deps:testing".
  #         command: |
  #           wget -O - https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh | sudo bash
  #           ansible-playbook -i "localhost," -c local tests/test.yml -vvv

  # run-ansible-playbook-test-on-circlci-ubuntu-16-04:
  #   executor: executor-ubuntu-16-04
  #   working_directory: ~/.ansible/roles/ansible-role-install-snap
  #   steps:
  #     - checkout
  #     - run:
  #         name: Run Ansible test on "circleci/buildpack-deps:16.04".
  #         command: |
  #           wget -O - https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh | sudo bash
  #           ansible-playbook -i "localhost," -c local tests/test.yml -vvv

  # run-ansible-playbook-test-on-circlci-ubuntu-18-04:
  #   executor: executor-ubuntu-18-04
  #   working_directory: ~/.ansible/roles/ansible-role-install-snap
  #   steps:
  #     - checkout
  #     - run:
  #         name: Run Ansible test on "circleci/buildpack-deps:18.04".
  #         command: |
  #           # wget -O - https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh | sudo bash
  #           ansible-playbook -i "localhost," -c local tests/test.yml -vvv

  # run-ansible-playbook-test-on-circlci-ubuntu-20-04:
  #   executor: executor-ubuntu-20-04
  #   working_directory: ~/.ansible/roles/ansible-role-install-snap
  #   steps:
  #     - checkout
  #     - run:
  #         name: Run Ansible test on "circleci/buildpack-deps:20.04".
  #         command: |
  #           wget -O - https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh | sudo bash
  #           ansible-playbook -i "localhost," -c local tests/test.yml -vvv

  # run-ansible-playbook-test-on-dockerhub-centos-7:
  #   executor: from-dockerhub-centos-7
  #   working_directory: ~/.ansible/roles/ansible-role-install-snap
  #   steps:
  #     - checkout
  #     - run:
  #         name: Run Ansible test on "dockerhub-centos-7".
  #         command: |
  #           yum -y install wget sudo
  #           wget -O - https://raw.githubusercontent.com/neillturner/omnibus-ansible/master/ansible_install.sh | sudo bash
  #           ansible-playbook -i "localhost," -c local tests/test.yml -vvv

# # https://circleci.com/docs/2.0/executor-types/#using-multiple-docker-images
#   run-test-bridge:
#     executor: test-bridge
#     working_directory: ~/.ansible/roles/ansible-role-install-snap
#     steps:
#       - checkout
#       - run:
#           name: Run 2 containers 4 test local network v2
#           command: |
#             ansible-playbook -i "localhost," -c local tests/test.yml -vvv

  job-run-ansible-test-01:
    executor: executor-ubuntu-20-04
    working_directory: << pipeline.parameters.parameter-working-directory >>
    steps:
      - checkout
      - command-run-ansible-test

workflows:
  simple-run-test:
    jobs:
      # - run-ansible-playbook-test-on-circlci-debian-oldstable
      # - run-ansible-playbook-test-on-circlci-debian-stable
      # - run-ansible-playbook-test-on-circlci-debian-testing
      # - run-ansible-playbook-test-on-circlci-ubuntu-16-04
      # - run-ansible-playbook-test-on-circlci-ubuntu-18-04
      # - run-ansible-playbook-test-on-circlci-ubuntu-20-04
      # - run-ansible-playbook-test-on-dockerhub-centos-7
      - job-run-ansible-test-01
